#!/bin/bash
################################################################################
# Zero-Touch Kubernetes Cluster Configuration
#
# This file sources configuration from platform/.env and adds
# zero-touch specific settings for autonomous image deployment.
################################################################################

# Get directories (don't overwrite SCRIPT_DIR from caller)
CONFIG_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
OSBUILD_ROOT="$(dirname "$CONFIG_DIR")"
PLATFORM_ROOT="$(dirname "$OSBUILD_ROOT")/platform"

# Source platform configuration if available
if [ -f "$PLATFORM_ROOT/.env" ]; then
    echo "Loading configuration from $PLATFORM_ROOT/.env"
    source "$PLATFORM_ROOT/.env"
else
    echo "ERROR: Platform .env not found at $PLATFORM_ROOT/.env"
    echo "Please create platform/.env from .env.sample"
    exit 1
fi

################################################################################
# ZERO-TOUCH SPECIFIC CONFIGURATION
################################################################################

# Build platform (x64 or pi5)
BUILD_PLATFORM="${BUILD_PLATFORM:-x64}"  # Set via command line: BUILD_PLATFORM=pi5 ./build-zerotouch.sh

# OSBuild settings
case "$BUILD_PLATFORM" in
    x64)
        BASE_IMAGE_SIZE="5G"
        IMAGE_FORMAT="qcow2"
        ARCH="amd64"
        K8S_ARCH="amd64"
        ;;
    pi5)
        BASE_IMAGE_SIZE="4.5G"
        IMAGE_FORMAT="raw"
        ARCH="arm64"
        K8S_ARCH="arm64"
        ;;
    *)
        echo "ERROR: Unknown BUILD_PLATFORM: $BUILD_PLATFORM (must be x64 or pi5)"
        exit 1
        ;;
esac

# Output directories
OUTPUT_DIR="${OSBUILD_ROOT}/output-zerotouch-${BUILD_PLATFORM}"
CREDENTIALS_DIR="${OUTPUT_DIR}/credentials"
BUILD_WORK_DIR="${OSBUILD_ROOT}/work-zerotouch-${BUILD_PLATFORM}"

# Base image location (will be built by OSBuild)
if [ "$BUILD_PLATFORM" = "x64" ]; then
    BASE_IMAGE="${OSBUILD_ROOT}/output-x64/k8s-x64-latest.img"
elif [ "$BUILD_PLATFORM" = "pi5" ]; then
    BASE_IMAGE="${OSBUILD_ROOT}/output/rpi5-k8s-latest.img"
fi

# Cloud-init templates
CLOUD_INIT_TEMPLATE_DIR="${OSBUILD_ROOT}/cloud-init"

# Bootstrap scripts
BOOTSTRAP_DIR="${OSBUILD_ROOT}/bootstrap"

# Manifests and Helm values
MANIFESTS_DIR="${OSBUILD_ROOT}/manifests"
HELM_VALUES_DIR="${OSBUILD_ROOT}/helm-values"

################################################################################
# NETWORK CONFIGURATION (from platform/.env)
################################################################################

# Already sourced from platform/.env:
# - PRIVATE_SUBNET, PRIVATE_GATEWAY, PRIVATE_IP_START
# - EXTERNAL_SUBNET, EXTERNAL_GATEWAY, EXTERNAL_IP_START
# - VIP, METALLB_IP_RANGE
# - POD_CIDR, SERVICE_CIDR

# Calculate node IPs
NODE1_PRIVATE_IP="$PRIVATE_IP_START"
NODE2_PRIVATE_IP="$(echo $PRIVATE_IP_START | awk -F. '{print $1"."$2"."$3"."$4+1}')"
NODE3_PRIVATE_IP="$(echo $PRIVATE_IP_START | awk -F. '{print $1"."$2"."$3"."$4+2}')"

NODE1_EXTERNAL_IP="$EXTERNAL_IP_START"
NODE2_EXTERNAL_IP="$(echo $EXTERNAL_IP_START | awk -F. '{print $1"."$2"."$3"."$4+1}')"
NODE3_EXTERNAL_IP="$(echo $EXTERNAL_IP_START | awk -F. '{print $1"."$2"."$3"."$4+2}')"

# Network interface (eth0 for Pi5, will be detected for x64)
NETWORK_INTERFACE="${NETWORK_INTERFACE:-eth0}"

# Extract netmask from CIDR
PRIVATE_NETMASK="$(echo $PRIVATE_SUBNET | cut -d/ -f2)"
EXTERNAL_NETMASK="$(echo $EXTERNAL_SUBNET | cut -d/ -f2)"

################################################################################
# CLUSTER CONFIGURATION (from platform/.env)
################################################################################

# Already sourced:
# - CLUSTER_NAME, NODE_COUNT, K8S_VERSION
# - CONTROL_PLANE_ON_ALL_NODES
# - CNI_PLUGIN

# API server endpoint (first node)
API_SERVER_ENDPOINT="${NODE1_PRIVATE_IP}:6443"

################################################################################
# SERVICE DEPLOYMENT CONFIGURATION
################################################################################

# Force enable all services for zero-touch deployment
DEPLOY_FLANNEL=true
DEPLOY_METALLB=true
DEPLOY_INGRESS=true
DEPLOY_LONGHORN="${DEPLOY_LONGHORN:-true}"
DEPLOY_MINIO="${DEPLOY_MINIO:-true}"
DEPLOY_PROMETHEUS="${DEPLOY_PROMETHEUS:-true}"
DEPLOY_GRAFANA="${DEPLOY_GRAFANA:-true}"
DEPLOY_PORTAINER=true
DEPLOY_WELCOME_PAGE=true

# Service versions (from platform/.env or defaults)
METALLB_VERSION="${METALLB_VERSION:-v0.14.9}"
INGRESS_NGINX_VERSION="${INGRESS_NGINX_VERSION:-v1.11.3}"
LONGHORN_VERSION="${LONGHORN_VERSION:-v1.7.2}"
FLANNEL_VERSION="${FLANNEL_VERSION:-latest}"

################################################################################
# CREDENTIALS CONFIGURATION
################################################################################

# SSH configuration
SSH_USER="${SSH_USER:-k8sadmin}"
SSH_KEY_PATH="${CREDENTIALS_DIR}/id_rsa"
SSH_PUB_KEY_PATH="${CREDENTIALS_DIR}/id_rsa.pub"

# Grafana admin password
GRAFANA_ADMIN_PASSWORD="${GRAFANA_ADMIN_PASSWORD:-admin}"

# MinIO credentials
MINIO_ROOT_USER="${MINIO_ROOT_USER:-admin}"
MINIO_ROOT_PASSWORD="${MINIO_ROOT_PASSWORD:-}"  # Will be generated if empty

################################################################################
# KUBERNETES TOKEN CONFIGURATION
################################################################################

# Long-lived token for node joins (100 years)
KUBEADM_TOKEN_TTL="876000h"

# Certificate key for control plane joins (will be generated)
KUBEADM_CERT_KEY=""

################################################################################
# TIMEOUT CONFIGURATION
################################################################################

# Bootstrap timeouts (seconds)
BOOTSTRAP_TIMEOUT=1800  # 30 minutes total
K8S_INIT_TIMEOUT=600    # 10 minutes for kubeadm init
SERVICE_DEPLOY_TIMEOUT=900  # 15 minutes for all services
NODE_JOIN_TIMEOUT=600   # 10 minutes for node join

# Wait intervals (seconds)
WAIT_INTERVAL=10
API_SERVER_WAIT_INTERVAL=5

################################################################################
# LOGGING CONFIGURATION
################################################################################

# Bootstrap log location (on target system)
BOOTSTRAP_LOG="/var/log/bootstrap.log"
BOOTSTRAP_STATE_DIR="/opt/bootstrap/.state"

################################################################################
# HELPER FUNCTIONS
################################################################################

# Calculate IP with offset
calc_ip() {
    local base_ip="$1"
    local offset="$2"
    echo "$base_ip" | awk -F. -v offset="$offset" '{print $1"."$2"."$3"."$4+offset}'
}

# Get node hostname
get_node_hostname() {
    local node_num="$1"
    echo "${CLUSTER_NAME}-node${node_num}"
}

# Get node private IP
get_node_private_ip() {
    local node_num="$1"
    calc_ip "$PRIVATE_IP_START" $((node_num - 1))
}

# Get node external IP
get_node_external_ip() {
    local node_num="$1"
    calc_ip "$EXTERNAL_IP_START" $((node_num - 1))
}

# Export configuration for use by other scripts
export OSBUILD_ROOT PLATFORM_ROOT OUTPUT_DIR CREDENTIALS_DIR BUILD_WORK_DIR
export BASE_IMAGE BASE_IMAGE_SIZE IMAGE_FORMAT ARCH K8S_ARCH BUILD_PLATFORM
export NODE1_PRIVATE_IP NODE2_PRIVATE_IP NODE3_PRIVATE_IP
export NODE1_EXTERNAL_IP NODE2_EXTERNAL_IP NODE3_EXTERNAL_IP
export NETWORK_INTERFACE PRIVATE_NETMASK EXTERNAL_NETMASK
export API_SERVER_ENDPOINT
export DEPLOY_FLANNEL DEPLOY_METALLB DEPLOY_INGRESS DEPLOY_LONGHORN DEPLOY_MINIO
export DEPLOY_PROMETHEUS DEPLOY_GRAFANA DEPLOY_PORTAINER DEPLOY_WELCOME_PAGE
export METALLB_VERSION INGRESS_NGINX_VERSION LONGHORN_VERSION FLANNEL_VERSION
export SSH_USER SSH_KEY_PATH SSH_PUB_KEY_PATH
export GRAFANA_ADMIN_PASSWORD MINIO_ROOT_USER MINIO_ROOT_PASSWORD
export KUBEADM_TOKEN_TTL KUBEADM_CERT_KEY
export BOOTSTRAP_TIMEOUT K8S_INIT_TIMEOUT SERVICE_DEPLOY_TIMEOUT NODE_JOIN_TIMEOUT
export BOOTSTRAP_LOG BOOTSTRAP_STATE_DIR

echo "Zero-touch configuration loaded for platform: $BUILD_PLATFORM"
