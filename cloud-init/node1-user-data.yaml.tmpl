#cloud-config

# Zero-Touch Kubernetes Node 1 Cloud-Init Configuration
# Generated by build-zerotouch.sh

hostname: ${CLUSTER_NAME}-node1
fqdn: ${CLUSTER_NAME}-node1.local

# User configuration
users:
  - name: ${SSH_USER}
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo
    shell: /bin/bash
    ssh_authorized_keys:
      - ${SSH_PUBLIC_KEY}
    lock_passwd: false
    # Set password for console access (password: ${SSH_PASSWORD})
    passwd: ${SSH_PASSWORD_HASH}

# Disable automatic updates
package_update: false
package_upgrade: false
apt:
  preserve_sources_list: true

# System configuration
timezone: UTC

# Network configuration
write_files:
  - path: /etc/netplan/50-cloud-init.yaml
    permissions: '0644'
    content: |
      network:
        version: 2
        ethernets:
          ens3:
            dhcp4: false
            addresses:
              - ${NODE1_PRIVATE_IP}/${PRIVATE_NETMASK}
              - ${NODE1_EXTERNAL_IP}/${EXTERNAL_NETMASK}
            routes:
              - to: default
                via: ${PRIVATE_GATEWAY}
            nameservers:
              addresses:
                - 8.8.8.8
                - 8.8.4.4

# Run commands on first boot
runcmd:
  # Apply network configuration
  - netplan apply
  - sleep 5

  # Set hostname
  - hostnamectl set-hostname ${CLUSTER_NAME}-node1

  # Export environment variables for bootstrap script
  - export NODE1_PRIVATE_IP="${NODE1_PRIVATE_IP}"
  - export NODE1_EXTERNAL_IP="${NODE1_EXTERNAL_IP}"
  - export PRIVATE_NETMASK="${PRIVATE_NETMASK}"
  - export EXTERNAL_NETMASK="${EXTERNAL_NETMASK}"
  - export PRIVATE_GATEWAY="${PRIVATE_GATEWAY}"
  - export NETWORK_INTERFACE="${NETWORK_INTERFACE}"
  - export VIP="${VIP}"
  - export METALLB_IP_RANGE="${METALLB_IP_RANGE}"
  - export K8S_VERSION="${K8S_VERSION}"
  - export POD_CIDR="${POD_CIDR}"
  - export SERVICE_CIDR="${SERVICE_CIDR}"
  - export METALLB_VERSION="${METALLB_VERSION}"
  - export INGRESS_NGINX_VERSION="${INGRESS_NGINX_VERSION}"
  - export LONGHORN_VERSION="${LONGHORN_VERSION}"
  - export LONGHORN_DATA_DIR="${LONGHORN_DATA_DIR}"
  - export DEPLOY_LONGHORN="${DEPLOY_LONGHORN}"
  - export DEPLOY_MINIO="${DEPLOY_MINIO}"
  - export DEPLOY_GRAFANA="${DEPLOY_GRAFANA}"
  - export DEPLOY_PORTAINER="${DEPLOY_PORTAINER}"
  - export DEPLOY_WELCOME_PAGE="${DEPLOY_WELCOME_PAGE}"
  - export GRAFANA_ADMIN_PASSWORD="${GRAFANA_ADMIN_PASSWORD}"
  - export MINIO_ROOT_USER="${MINIO_ROOT_USER}"
  - export MINIO_ROOT_PASSWORD="${MINIO_ROOT_PASSWORD}"
  - export CLUSTER_NAME="${CLUSTER_NAME}"

  # Make bootstrap script executable
  - chmod +x /opt/bootstrap/node1-init.sh
  - chmod +x /opt/bootstrap/lib/bootstrap-common.sh

  # Run bootstrap script (with output to log and console)
  - /opt/bootstrap/node1-init.sh 2>&1 | tee -a /var/log/cloud-init-output.log

# Power state - do not reboot after cloud-init
power_state:
  mode: noreboot
