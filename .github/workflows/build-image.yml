name: Build Raspberry Pi OS Image

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      kubernetes_version:
        description: 'Kubernetes version'
        required: false
        default: '1.28.0'
      image_version:
        description: 'Custom image version (optional)'
        required: false

env:
  K8S_VERSION: ${{ github.event.inputs.kubernetes_version || '1.28.0' }}
  IMAGE_VERSION: ${{ github.event.inputs.image_version || github.sha }}
  RASPIOS_VERSION: '2024-07-04-raspios-bookworm-arm64-lite'

jobs:
  build-image:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          qemu-user-static \
          qemu-utils \
          debootstrap \
          kpartx \
          parted \
          wget \
          curl \
          jq \
          xz-utils \
          fdisk \
          dosfstools

    - name: Cache Raspberry Pi OS base image
      id: cache-raspios
      uses: actions/cache@v4
      with:
        path: image-build/cache
        key: raspios-${{ env.RASPIOS_VERSION }}

    - name: Download Raspberry Pi OS base image
      if: steps.cache-raspios.outputs.cache-hit != 'true'
      run: |
        mkdir -p image-build/cache
        cd image-build/cache
        wget -q --show-progress \
          https://downloads.raspberrypi.com/raspios_lite_arm64/images/raspios_lite_arm64-2024-07-04/${RASPIOS_VERSION}.img.xz
        echo "Base image downloaded successfully"

    - name: Extract base image
      run: |
        mkdir -p image-build/work
        xz -dc image-build/cache/${RASPIOS_VERSION}.img.xz > image-build/work/base.img
        ls -lh image-build/work/base.img

    - name: Expand image for customization
      run: |
        cd image-build/work
        # Add 2GB for packages and customization
        truncate -s +2G base.img

        # Expand partition and filesystem
        echo ", +" | sudo sfdisk -N 2 base.img

        # Setup loop device
        LOOP_DEVICE=$(sudo losetup -fP --show base.img)
        echo "LOOP_DEVICE=${LOOP_DEVICE}" >> $GITHUB_ENV

        # Resize filesystem
        sudo e2fsck -f ${LOOP_DEVICE}p2 || true
        sudo resize2fs ${LOOP_DEVICE}p2

        echo "Image expanded successfully"

    - name: Mount image partitions
      run: |
        mkdir -p /tmp/boot /tmp/root
        sudo mount ${LOOP_DEVICE}p2 /tmp/root
        sudo mount ${LOOP_DEVICE}p1 /tmp/boot

    - name: Install Kubernetes prerequisites
      run: |
        sudo ./image-build/scripts/01-install-k8s.sh /tmp/root "${K8S_VERSION}"

    - name: Install bootstrap framework
      run: |
        sudo ./image-build/scripts/02-install-bootstrap.sh /tmp/root

    - name: Configure first-boot service
      run: |
        sudo ./image-build/scripts/03-configure-firstboot.sh /tmp/root

    - name: Optimize and cleanup
      run: |
        sudo ./image-build/scripts/04-cleanup.sh /tmp/root

    - name: Unmount and finalize image
      run: |
        sudo umount /tmp/boot
        sudo umount /tmp/root
        sudo losetup -d ${LOOP_DEVICE}

        # Shrink image to minimum size
        cd image-build/work
        sudo ../../scripts/shrink-image.sh base.img

    - name: Create output artifacts
      run: |
        mkdir -p output/netboot

        # Copy disk image
        cp image-build/work/base.img output/rpi5-k8s-${IMAGE_VERSION}.img

        # Extract rootfs for netboot
        ./scripts/extract-rootfs.sh \
          output/rpi5-k8s-${IMAGE_VERSION}.img \
          output/netboot/rootfs.tar.gz

        # Generate checksums
        cd output
        sha256sum rpi5-k8s-${IMAGE_VERSION}.img > rpi5-k8s-${IMAGE_VERSION}.img.sha256
        sha256sum netboot/rootfs.tar.gz > netboot/rootfs.tar.gz.sha256

        # Create metadata
        cat > metadata.json <<EOF
        {
          "version": "${IMAGE_VERSION}",
          "kubernetes_version": "${K8S_VERSION}",
          "base_image": "${RASPIOS_VERSION}",
          "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "git_commit": "${GITHUB_SHA}",
          "git_ref": "${GITHUB_REF}"
        }
        EOF

        ls -lh

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: raspberry-pi-images-${{ env.IMAGE_VERSION }}
        retention-days: 7  # Keep for 7 days only (save storage quota)
        path: |
          output/*.img
          output/*.sha256
          output/metadata.json
          output/netboot/*

    - name: Upload to Google Drive
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      env:
        RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
      run: |
        if [ -z "$RCLONE_CONFIG" ]; then
          echo "‚è≠Ô∏è  Skipping Google Drive upload (RCLONE_CONFIG not set)"
          echo "To enable: Add RCLONE_CONFIG secret in GitHub repo settings"
        else
          echo "üì§ Uploading to Google Drive..."

          # Install rclone
          curl https://rclone.org/install.sh | sudo bash

          # Configure rclone from secret
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONFIG" > ~/.config/rclone/rclone.conf

          # Create dated directory name
          BUILD_DATE=$(date +%Y-%m-%d)
          DEST_DIR="osbuild-images/${BUILD_DATE}-${GITHUB_SHA:0:7}"

          # Upload files
          rclone copy output/rpi5-k8s-${IMAGE_VERSION}.img gdrive:${DEST_DIR}/
          rclone copy output/rpi5-k8s-${IMAGE_VERSION}.img.sha256 gdrive:${DEST_DIR}/
          rclone copy output/metadata.json gdrive:${DEST_DIR}/
          rclone copy output/netboot/rootfs.tar.gz gdrive:${DEST_DIR}/netboot/

          echo "‚úÖ Uploaded to Google Drive: ${DEST_DIR}"
        fi

    - name: Deploy to netboot server (dev)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "Would deploy to netboot server here"
        echo "Requires: NETBOOT_SERVER secret configured"
        # ./scripts/deploy-netboot.sh \
        #   output/netboot/rootfs.tar.gz \
        #   ${{ secrets.NETBOOT_SERVER }} \
        #   ${{ secrets.NETBOOT_SSH_KEY }}

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          output/rpi5-k8s-${{ env.IMAGE_VERSION }}.img
          output/rpi5-k8s-${{ env.IMAGE_VERSION }}.img.sha256
          output/metadata.json
        body: |
          # Raspberry Pi 5 Kubernetes Image

          **Version**: ${{ env.IMAGE_VERSION }}
          **Kubernetes**: ${{ env.K8S_VERSION }}
          **Base Image**: ${{ env.RASPIOS_VERSION }}

          ## Installation

          ### NVMe (Production)
          ```bash
          # Download and verify
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/rpi5-k8s-${{ env.IMAGE_VERSION }}.img
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/rpi5-k8s-${{ env.IMAGE_VERSION }}.img.sha256
          sha256sum -c rpi5-k8s-${{ env.IMAGE_VERSION }}.img.sha256

          # Flash to NVMe
          sudo dd if=rpi5-k8s-${{ env.IMAGE_VERSION }}.img of=/dev/nvme0n1 bs=4M status=progress conv=fsync
          ```

          ### Netboot (Development)
          Download rootfs artifact and deploy to NFS server.

          ## Features
          - Raspberry Pi OS Bookworm (64-bit)
          - Kubernetes ${{ env.K8S_VERSION }} (kubeadm, kubelet, kubectl)
          - First-boot auto-provisioning
          - Bootstrap scripts pulled from git
          - Supports both netboot and NVMe deployment
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Notify build completion
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "‚úÖ Image build completed successfully"
          echo "Image version: ${IMAGE_VERSION}"
          echo "Kubernetes version: ${K8S_VERSION}"
        else
          echo "‚ùå Image build failed"
        fi
