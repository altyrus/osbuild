version: '3.8'

services:
  builder:
    build:
      context: .
      dockerfile: Dockerfile
    privileged: true  # Required for loop devices and mounting
    volumes:
      # Mount output directory to host
      - ${OUTPUT_DIR:-./output}:/workspace/output
      # Mount cache directory (optional, speeds up builds)
      - ${CACHE_DIR:-./image-build/cache}:/workspace/image-build/cache
    environment:
      - K8S_VERSION=${K8S_VERSION:-1.28.0}
      - IMAGE_VERSION=${IMAGE_VERSION:-docker-$(shell date +%Y%m%d-%H%M%S)}
      - RASPIOS_VERSION=${RASPIOS_VERSION:-2024-07-04-raspios-bookworm-arm64-lite}
    # Clean up container after build
    container_name: osbuild-builder
    stdin_open: false
    tty: false
